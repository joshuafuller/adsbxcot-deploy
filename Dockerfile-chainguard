# Use only Chainguard Python for both build and run
FROM cgr.dev/chainguard/python:latest

# Install packages needed to build and run PyTAK & ADSBXCOT
# build-base = (gcc, musl-dev, etc.), needed if any wheel compilation is required
RUN apk add --no-cache \
    git \
    libffi-dev \
    openssl-dev \
    build-base

WORKDIR /app

# Clone PyTAK and ADSBXCOT
RUN git clone --depth 1 https://github.com/snstac/pytak.git /app/pytak && \
    git clone --depth 1 https://github.com/snstac/adsbxcot.git /app/adsbxcot

# Update PyTAK constants for larger queue sizes
RUN sed -i 's/DEFAULT_MAX_OUT_QUEUE = 100/DEFAULT_MAX_OUT_QUEUE = 5000/' /app/pytak/pytak/constants.py && \
    sed -i 's/DEFAULT_MAX_IN_QUEUE = 500/DEFAULT_MAX_IN_QUEUE = 5000/' /app/pytak/pytak/constants.py

# Install PyTAK & ADSBXCOT using pip
RUN pip install --no-cache-dir /app/pytak /app/adsbxcot

# Copy Python wrapper script
COPY adsbxcot-wrapper.py /usr/local/bin/

# The entrypoint is the Python script
ENTRYPOINT ["python", "/usr/local/bin/adsbxcot-wrapper.py"]
